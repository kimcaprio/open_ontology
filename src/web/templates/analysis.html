<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    
    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/material.min.css" rel="stylesheet">
    <link href="/static/css/style.css" rel="stylesheet">
    
    <style>
        .analysis-container {
            display: flex;
            height: calc(100vh - 120px);
            margin-top: 20px;
            margin-bottom: 60px;
        }
        
        .catalog-sidebar {
            width: 300px;
            background: #f8f9fa;
            border-right: 1px solid #dee2e6;
            overflow-y: auto;
            padding: 15px;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px;
            overflow-y: auto;
            scroll-behavior: smooth;
            min-height: calc(100vh - 140px);
        }
        
        .query-editor {
            height: 300px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }
        
        .results-panel {
            flex: 1;
            margin-top: 15px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            overflow: visible;
            min-height: 500px;
            scroll-margin-top: 20px;
            margin-bottom: 40px;
        }
        
        .results-table {
            max-height: 400px;
            overflow: auto;
        }
        
        .catalog-tree .catalog-item {
            margin-bottom: 10px;
        }
        
        .catalog-tree .catalog-header {
            background: #007bff;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 5px;
        }
        
        .catalog-tree .schema-item {
            margin-left: 15px;
            margin-bottom: 5px;
        }
        
        .catalog-tree .schema-header {
            background: #6c757d;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        
        .catalog-tree .table-item {
            margin-left: 30px;
            padding: 4px 8px;
            background: #e9ecef;
            margin-bottom: 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85em;
        }
        
        .catalog-tree .table-item:hover {
            background: #dee2e6;
        }
        
        .query-actions {
            margin-bottom: 15px;
        }
        
        .sample-queries {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .sample-query-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .sample-query-item:hover {
            background: #f1f3f4;
        }
        
        .query-stats {
            font-size: 0.9em;
            color: #6c757d;
            margin-top: 10px;
        }
        
        .cross-catalog-examples {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .CodeMirror {
            font-family: 'Monaco', 'Consolas', monospace;
            height: 300px;
        }

        /* New styles for visualization and NL query */
        .nl-query-panel {
            background: #e8f5e8;
            border: 1px solid #b6d7b6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .chat-interface {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .chat-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            font-size: 14px;
        }

        .voice-button {
            border: none;
            background: #28a745;
            color: white;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .voice-button:hover {
            background: #218838;
            transform: scale(1.05);
        }

        .voice-button.recording {
            background: #dc3545;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .results-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            margin: 0;
            padding: 0;
        }

        .results-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            color: #6c757d;
            font-weight: 500;
            transition: all 0.2s ease-in-out;
            flex: 1;
            text-align: center;
        }

        .results-tab:hover {
            color: #007bff;
            background-color: rgba(0, 123, 255, 0.05);
        }

        .results-tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background: white;
            font-weight: 600;
        }

        .visualization-container {
            min-height: 500px;
            padding: 30px 20px;
            position: relative;
            margin-bottom: 50px;
            overflow: visible;
        }

        #chart-results-content {
            padding-bottom: 80px;
            min-height: 600px;
            overflow: visible;
        }
        
        #chart-container {
            min-height: 500px;
            height: auto;
            width: calc(100% - 20px);
            max-width: 100%;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            position: relative;
            overflow: visible;
            margin: 20px 10px 40px 10px;
            padding: 15px;
            box-sizing: border-box;
        }
        
        #chart-container .plotly-graph-div {
            width: 100% !important;
            height: 100% !important;
            min-height: 420px !important;
        }
        
        #table-results-content {
            padding: 20px;
            max-height: none;
            overflow-x: auto;
        }

        .llm-model-selector {
            background: #f0f4f8;
            border: 1px solid #c5d1e0;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .model-selector-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .model-selector {
            min-width: 200px;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            background: white;
            font-size: 14px;
        }

        .model-info {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }

        .provider-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .provider-openai { background: #10a37f; color: white; }
        .provider-anthropic { background: #c17b4e; color: white; }
        .provider-aws_bedrock { background: #ff9900; color: white; }
        .provider-google { background: #4285f4; color: white; }
        .provider-cohere { background: #1b365b; color: white; }
        .provider-ollama { background: #6366f1; color: white; }
        .provider-vllm { background: #8b5cf6; color: white; }

        .model-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }

        .status-indicator.status-success {
            background-color: #28a745;
        }

        .status-indicator.status-error {
            background-color: #dc3545;
        }

        .status-indicator.status-warning {
            background-color: #ffc107;
        }

        .status-indicator.status-loading {
            background-color: #6c757d;
            animation: pulse 1.5s infinite;
        }

        .model-details {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
        }

        .chart-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #e9ecef;
        }

        .chart-recommendation {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .visualization-container {
            min-height: 500px;
            padding: 30px 20px;
            position: relative;
            margin-bottom: 50px;
            overflow: visible;
        }

        /* Custom styles for Ontology Platform */

        body {
            background-color: #f8f9fa;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            padding-bottom: 80px;
            scroll-behavior: smooth;
        }

        .container-fluid {
            padding-bottom: 60px;
        }

        .analysis-container {
            margin-bottom: 60px;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-database me-2"></i>
                Ontology Platform
            </a>
            
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">
                    <i class="fas fa-home me-1"></i>Home
                </a>
                <a class="nav-link" href="/datasources">
                    <i class="fas fa-plug me-1"></i>Data Sources
                </a>
                <a class="nav-link" href="/catalog">
                    <i class="fas fa-folder me-1"></i>Catalog
                </a>
                <a class="nav-link" href="/ontology">
                    <i class="fas fa-sitemap me-1"></i>Ontology
                </a>
                <a class="nav-link active" href="/analysis">
                    <i class="fas fa-search me-1"></i>Analysis
                </a>
                <a class="nav-link" href="/activity-logs">
                    <i class="fas fa-list me-1"></i>Activity Logs
                </a>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="page-title">
                    <i class="fas fa-search me-2"></i>
                    SQL Analysis
                    <small class="text-muted">- Trino MPP Engine</small>
                </h1>
                <p class="lead">Query and analyze data across multiple heterogeneous databases using Trino distributed SQL engine.</p>
            </div>
        </div>

        <div class="analysis-container">
            <!-- Catalog Sidebar -->
            <div class="catalog-sidebar">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="fas fa-database me-2"></i>Data Catalog</h5>
                    <button class="btn btn-sm btn-outline-primary" onclick="refreshCatalog()">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <div id="catalog-stats" class="alert alert-info small mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    Loading catalog data...
                </div>
                
                <div id="catalog-tree" class="catalog-tree">
                    <!-- Catalog tree will be populated here -->
                </div>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <!-- Natural Language Query Panel -->
                <div class="nl-query-panel">
                    <h6><i class="fas fa-comments me-2"></i>Natural Language Query</h6>
                    <p class="small mb-3">Ask questions about your data in plain English. Use voice input or type your query.</p>
                    
                    <div class="chat-interface">
                        <div class="chat-input-group">
                            <input 
                                type="text" 
                                class="chat-input" 
                                id="nl-query-input" 
                                placeholder="e.g., 'Show me the top 10 customers by sales' or 'How many employees are in each department?'"
                                onkeypress="handleNLQueryKeyPress(event)"
                            >
                            <button class="voice-button" id="voice-button" onclick="toggleVoiceInput()" title="Click and speak">
                                <i class="fas fa-microphone"></i>
                            </button>
                            <button class="btn btn-success" onclick="executeNaturalLanguageQuery()">
                                <i class="fas fa-magic me-1"></i>Ask AI
                            </button>
                        </div>
                        
                        <div id="nl-query-status" class="small text-muted mt-2" style="display: none;">
                            <!-- Status messages will appear here -->
                        </div>
                    </div>
                </div>

                <!-- LLM Model Selector -->
                <div class="llm-model-selector">
                    <h6><i class="fas fa-brain me-2"></i>AI Model Configuration</h6>
                    <p class="small mb-3">Select the LLM model for natural language processing and visualization recommendations.</p>
                    
                    <div class="model-selector-group">
                        <div>
                            <label for="model-selector" class="form-label small fw-bold">Active Model:</label>
                            <select class="model-selector" id="model-selector" onchange="changeModel()">
                                <option value="">Loading models...</option>
                            </select>
                        </div>
                        
                        <div>
                            <label for="provider-filter" class="form-label small fw-bold">Filter by Provider:</label>
                            <select class="model-selector" id="provider-filter" onchange="filterModelsByProvider()">
                                <option value="all">All Providers</option>
                                <option value="openai">OpenAI</option>
                                <option value="anthropic">Anthropic</option>
                                <option value="aws_bedrock">AWS Bedrock</option>
                                <option value="google">Google</option>
                                <option value="cohere">Cohere</option>
                                <option value="ollama">Ollama (Local)</option>
                                <option value="vllm">vLLM (Custom)</option>
                            </select>
                        </div>
                        
                        <button class="btn btn-sm btn-outline-primary" onclick="refreshModels()">
                            <i class="fas fa-sync-alt me-1"></i>Refresh All Models
                        </button>
                    </div>
                    
                    <div class="model-status">
                        <span class="small fw-bold">Status:</span>
                        <div class="status-indicator" id="model-status-indicator"></div>
                        <span class="small" id="model-status-text">Loading...</span>
                    </div>
                    
                    <div class="model-info" id="model-info">
                        <!-- Model information will be displayed here -->
                    </div>
                </div>

                <!-- Cross-Catalog Examples -->
                <div class="cross-catalog-examples">
                    <h6><i class="fas fa-lightbulb me-2"></i>Cross-Catalog Query Examples</h6>
                    <p class="small mb-2">Click an example to load it into the query editor:</p>
                    <div id="cross-catalog-examples-list">
                        <!-- Examples will be loaded here -->
                    </div>
                </div>

                <!-- Sample Queries Panel -->
                <div id="sample-queries-panel" class="sample-queries" style="display: none;">
                    <h6><i class="fas fa-code me-2"></i>Sample Queries for <span id="selected-table-name"></span></h6>
                    <div id="sample-queries-list">
                        <!-- Sample queries will be populated here -->
                    </div>
                </div>

                <!-- Query Actions -->
                <div class="query-actions">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="btn-group" role="group">
                                <button type="button" class="btn btn-primary" onclick="executeSQL()">
                                    <i class="fas fa-play me-2"></i>Execute SQL
                                </button>
                                <button type="button" class="btn btn-success" onclick="executeQuery()">
                                    <i class="fas fa-cogs me-2"></i>Run with Trino
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="clearQuery()">
                                    <i class="fas fa-eraser me-2"></i>Clear
                                </button>
                                <button type="button" class="btn btn-info" onclick="formatQuery()">
                                    <i class="fas fa-magic me-2"></i>Format
                                </button>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <small class="text-muted">
                                <i class="fas fa-keyboard me-1"></i>
                                Press <kbd>Ctrl</kbd>+<kbd>Enter</kbd> to execute SQL
                                <br>
                                <i class="fas fa-info-circle me-1"></i>
                                SQL execution includes auto-visualization
                            </small>
                        </div>
                    </div>
                    
                    <!-- Query Status -->
                    <div id="query-status" class="small mt-2" style="display: none;">
                        <!-- Status messages will appear here -->
                    </div>
                </div>

                <!-- Query Editor -->
                <div class="query-editor-container">
                    <textarea id="query-editor" placeholder="-- Enter your SQL query here...
-- Example: SELECT department_name, COUNT(*) as employee_count 
--          FROM employees e JOIN departments d ON e.department_id = d.id 
--          GROUP BY department_name ORDER BY employee_count DESC;
--
-- Press Ctrl+Enter to execute with visualization
-- Use 'Execute SQL' for quick execution with demo data"></textarea>
                </div>

                <!-- Query Results Section -->
                <div id="query-results" style="display: none;">
                    <!-- Results will be populated by displayQueryResults() function -->
                </div>

                <!-- Results Panel -->
                <div class="results-panel">
                    <!-- Results Tabs -->
                    <div class="results-tabs">
                        <button class="results-tab active" onclick="switchResultsTab('table')" id="table-tab">
                            <i class="fas fa-table me-2"></i>Table View
                        </button>
                        <button class="results-tab" onclick="switchResultsTab('chart')" id="chart-tab">
                            <i class="fas fa-chart-bar me-2"></i>Visualization
                        </button>
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
                        <h6 class="mb-0">
                            <i class="fas fa-table me-2"></i>Query Results
                        </h6>
                        <div id="query-stats" class="query-stats">
                            Ready to execute query
                        </div>
                    </div>
                    
                    <!-- Table Results Content -->
                    <div id="table-results-content" class="p-3">
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-play-circle fa-3x mb-3"></i>
                            <p>Run a query to see results here</p>
                        </div>
                    </div>

                    <!-- Visualization Results Content -->
                    <div id="chart-results-content" class="visualization-container" style="display: none;">
                        <div id="chart-recommendation" class="chart-recommendation" style="display: none;">
                            <h6><i class="fas fa-lightbulb me-2"></i>AI Visualization Recommendation</h6>
                            <div id="recommendation-text"></div>
                        </div>
                        
                        <div class="chart-controls" id="chart-controls" style="display: none;">
                            <div>
                                <label class="form-label small">Chart Type:</label>
                                <select class="form-select form-select-sm" id="chart-type-selector" onchange="updateVisualization()">
                                    <option value="table">Table</option>
                                    <option value="bar">Bar Chart</option>
                                    <option value="line">Line Chart</option>
                                    <option value="pie">Pie Chart</option>
                                    <option value="scatter">Scatter Plot</option>
                                    <option value="histogram">Histogram</option>
                                    <option value="box">Box Plot</option>
                                </select>
                            </div>
                            <button class="btn btn-sm btn-outline-primary" onclick="refreshVisualization()">
                                <i class="fas fa-sync-alt me-1"></i>Refresh Chart
                            </button>
                        </div>

                        <div id="chart-container">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-chart-bar fa-3x mb-3"></i>
                                <p>Execute a query to see AI-powered visualization recommendations</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/sql/sql.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>

    <script>
        let queryEditor;
        let currentCatalogData = null;
        let currentQueryResult = null;
        let currentVisualization = null;
        let recognition = null;
        let isRecording = false;
        let currentTableSelection = null;

        // Initialize CodeMirror and Speech Recognition
        document.addEventListener('DOMContentLoaded', function() {
            queryEditor = CodeMirror.fromTextArea(document.getElementById('query-editor'), {
                lineNumbers: true,
                mode: 'sql',
                theme: 'material',
                autoCloseBrackets: true,
                matchBrackets: true,
                indentUnit: 2,
                lineWrapping: true
            });

            // Add keyboard shortcut for SQL execution
            queryEditor.on('keydown', function(cm, event) {
                handleSQLKeyPress(event);
            });

            loadCatalogData();
            loadCrossCatalogExamples();
            initializeSpeechRecognition();
            loadLLMModels();
        });

        // Load catalog data
        async function loadCatalogData() {
            try {
                showQueryStatus('Loading Unity Catalog data...', 'info');
                
                const response = await fetch('/api/v1/analysis/catalog');
                if (!response.ok) {
                    throw new Error('Failed to load unified catalog data');
                }
                
                currentCatalogData = await response.json();
                renderCatalogTree(currentCatalogData);
                
                showQueryStatus(`Loaded unified catalog: ${currentCatalogData.total_catalogs} catalogs, ${currentCatalogData.total_schemas} schemas, ${currentCatalogData.total_tables} tables`, 'success');
                
                // Update catalog selector in NL query panel
                updateCatalogSelector();
                
            } catch (error) {
                console.error('Error loading catalog data:', error);
                showQueryStatus('Failed to load Unity Catalog data: ' + error.message, 'error');
                renderErrorMessage('Failed to load Unity Catalog data. Please check the connection.');
            }
        }

        // Render catalog tree with Unity Catalog indicators
        function renderCatalogTree(catalogData) {
            const treeContainer = document.querySelector('.catalog-tree');
            if (!treeContainer) return;

            let html = '';
            
            // Add catalog statistics header
            html += `
                <div class="catalog-stats mb-3">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="h6 text-primary">${catalogData.total_catalogs}</div>
                            <small class="text-muted">Catalogs</small>
                        </div>
                        <div class="col-4">
                            <div class="h6 text-info">${catalogData.total_schemas}</div>
                            <small class="text-muted">Schemas</small>
                        </div>
                        <div class="col-4">
                            <div class="h6 text-success">${catalogData.total_tables}</div>
                            <small class="text-muted">Tables</small>
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <span class="badge bg-warning text-dark">
                            <i class="fas fa-bolt me-1"></i>Trino Enabled
                        </span>
                        <span class="badge bg-success">
                            <i class="fas fa-layer-group me-1"></i>Unity Catalog
                        </span>
                    </div>
                </div>
            `;

            catalogData.catalogs.forEach(catalog => {
                // Determine catalog type and icon
                let catalogIcon = 'fas fa-database';
                let catalogBadge = '';
                
                if (catalog.connector === 'unity_catalog') {
                    catalogIcon = 'fas fa-layer-group';
                    catalogBadge = '<span class="badge bg-success ms-1">UC</span>';
                } else if (catalog.connector === 'mysql_via_unity_catalog') {
                    catalogIcon = 'fas fa-database';
                    catalogBadge = '<span class="badge bg-info ms-1">MySQL</span>';
                } else if (catalog.connector === 'mysql') {
                    catalogIcon = 'fas fa-database';
                    catalogBadge = '<span class="badge bg-info ms-1">MySQL</span>';
                }

                html += `
                    <div class="catalog-item">
                        <div class="catalog-header" onclick="toggleCatalog('${catalog.name}')">
                            <i class="${catalogIcon} me-2"></i>
                            ${catalog.name}
                            ${catalogBadge}
                            <span class="badge bg-warning ms-1">
                                <i class="fas fa-bolt" title="Trino Enabled"></i>
                            </span>
                            <small class="text-light ms-1">(${catalog.schemas.length} schemas)</small>
                        </div>
                        <div id="catalog-${catalog.name}" class="catalog-schemas" style="display: none;">
                            <!-- Schemas will be loaded when expanded -->
                        </div>
                    </div>
                `;
            });

            treeContainer.innerHTML = html;
        }

        // Toggle catalog and load schemas
        async function toggleCatalog(catalogName) {
            const schemasContainer = document.getElementById(`catalog-${catalogName}`);
            const isExpanded = schemasContainer.style.display !== 'none';

            if (isExpanded) {
                schemasContainer.style.display = 'none';
                return;
            }

            try {
                showQueryStatus(`Loading schemas for ${catalogName}...`, 'info');
                
                const response = await fetch(`/api/v1/analysis/catalogs/${catalogName}/schemas`);
                if (!response.ok) {
                    throw new Error('Failed to load schemas');
                }

                const schemas = await response.json();
                
                let html = '';
                schemas.forEach(schema => {
                    html += `
                        <div class="schema-item">
                            <div class="schema-header" onclick="toggleSchema('${catalogName}', '${schema.name}')">
                                <i class="fas fa-folder me-2"></i>
                                ${schema.name}
                                <small class="text-light ms-1">(${schema.tables.length} tables)</small>
                            </div>
                            <div id="schema-${catalogName}-${schema.name}" class="schema-tables" style="display: none;">
                                <!-- Tables will be loaded when expanded -->
                            </div>
                        </div>
                    `;
                });

                schemasContainer.innerHTML = html;
                schemasContainer.style.display = 'block';
                
                showQueryStatus(`Loaded ${schemas.length} schemas for ${catalogName}`, 'success');
                
            } catch (error) {
                console.error('Error loading schemas:', error);
                showQueryStatus(`Failed to load schemas: ${error.message}`, 'error');
            }
        }

        // Toggle schema and load tables
        async function toggleSchema(catalogName, schemaName) {
            const tablesContainer = document.getElementById(`schema-${catalogName}-${schemaName}`);
            const isExpanded = tablesContainer.style.display !== 'none';

            if (isExpanded) {
                tablesContainer.style.display = 'none';
                return;
            }

            try {
                showQueryStatus(`Loading tables for ${catalogName}.${schemaName}...`, 'info');
                
                const response = await fetch(`/api/v1/analysis/catalogs/${catalogName}/schemas/${schemaName}/tables`);
                if (!response.ok) {
                    throw new Error('Failed to load tables');
                }

                const tables = await response.json();
                
                let html = '';
                tables.forEach(table => {
                    html += `
                        <div class="table-item" onclick="selectTable('${catalogName}', '${schemaName}', '${table.name}')">
                            <i class="fas fa-table me-2"></i>
                            ${table.name}
                            <span class="badge bg-light text-dark ms-1">${table.columns.length} cols</span>
                            <span class="badge bg-warning ms-1">
                                <i class="fas fa-bolt" title="Trino Ready"></i>
                            </span>
                        </div>
                    `;
                });

                tablesContainer.innerHTML = html;
                tablesContainer.style.display = 'block';
                
                showQueryStatus(`Loaded ${tables.length} tables for ${catalogName}.${schemaName}`, 'success');
                
            } catch (error) {
                console.error('Error loading tables:', error);
                showQueryStatus(`Failed to load tables: ${error.message}`, 'error');
            }
        }

        // Select table and generate sample queries
        async function selectTable(catalogName, schemaName, tableName) {
            try {
                showQueryStatus(`Loading table details for ${catalogName}.${schemaName}.${tableName}...`, 'info');
                
                // Update current table selection for NL queries
                currentTableSelection = {
                    catalog: catalogName,
                    schema: schemaName,
                    table: tableName
                };
                
                // Get table info
                const response = await fetch(`/api/v1/analysis/catalogs/${catalogName}/schemas/${schemaName}/tables/${tableName}`);
                if (!response.ok) {
                    throw new Error('Failed to load table info');
                }

                const tableInfo = await response.json();
                
                // Update selected table name
                document.getElementById('selected-table-name').textContent = `${catalogName}.${schemaName}.${tableName}`;
                
                // Generate sample queries
                generateSampleQueries(catalogName, schemaName, tableName, tableInfo);
                
                // Show sample queries panel
                document.getElementById('sample-queries-panel').style.display = 'block';
                
                // Generate a sample SELECT query in the editor
                const sampleQuery = `-- Unity Catalog Query via Trino Engine
-- Table: ${catalogName}.${schemaName}.${tableName}
SELECT * 
FROM ${catalogName}.${schemaName}.${tableName} 
LIMIT 100;`;
                
                queryEditor.setValue(sampleQuery);
                
                showQueryStatus(`Selected table: ${catalogName}.${schemaName}.${tableName} (Trino Ready)`, 'success');
                
                // Update placeholder for natural language queries
                updateNLQueryPlaceholder();
                
            } catch (error) {
                console.error('Error selecting table:', error);
                showQueryStatus(`Failed to select table: ${error.message}`, 'error');
            }
        }

        // Generate sample queries for the selected table
        async function generateSampleQueries(catalogName, schemaName, tableName, tableInfo) {
            const queriesContainer = document.getElementById('sample-queries-list');
            
            // Generate various query types
            const sampleQueries = [
                {
                    type: 'SELECT',
                    description: 'Basic data exploration',
                    query: `SELECT * FROM ${catalogName}.${schemaName}.${tableName} LIMIT 100;`
                },
                {
                    type: 'COUNT',
                    description: 'Row count analysis',
                    query: `SELECT COUNT(*) as total_rows FROM ${catalogName}.${schemaName}.${tableName};`
                },
                {
                    type: 'DESCRIBE',
                    description: 'Table schema information',
                    query: `DESCRIBE ${catalogName}.${schemaName}.${tableName};`
                },
                {
                    type: 'GROUPBY',
                    description: 'Aggregation analysis',
                    query: `SELECT ${tableInfo.columns[0]?.name || 'column1'}, COUNT(*) as count 
FROM ${catalogName}.${schemaName}.${tableName} 
GROUP BY ${tableInfo.columns[0]?.name || 'column1'} 
ORDER BY count DESC 
LIMIT 20;`
                }
            ];

            // Add column-specific queries if available
            if (tableInfo.columns && tableInfo.columns.length > 0) {
                const numericColumns = tableInfo.columns.filter(col => 
                    col.type.toLowerCase().includes('int') || 
                    col.type.toLowerCase().includes('decimal') || 
                    col.type.toLowerCase().includes('double') ||
                    col.type.toLowerCase().includes('float')
                );

                if (numericColumns.length > 0) {
                    sampleQueries.push({
                        type: 'STATS',
                        description: 'Statistical analysis',
                        query: `SELECT 
    MIN(${numericColumns[0].name}) as min_value,
    MAX(${numericColumns[0].name}) as max_value,
    AVG(${numericColumns[0].name}) as avg_value,
    COUNT(DISTINCT ${numericColumns[0].name}) as unique_values
FROM ${catalogName}.${schemaName}.${tableName};`
                    });
                }
            }

            let html = '';
            sampleQueries.forEach(query => {
                html += `
                    <div class="sample-query-item" onclick="loadQueryIntoEditor('${query.query.replace(/'/g, "\\'")}')">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${query.type}</strong>
                                <small class="text-muted ms-2">${query.description}</small>
                            </div>
                            <span class="badge bg-warning">
                                <i class="fas fa-bolt"></i> Trino
                            </span>
                        </div>
                        <pre class="mt-2 mb-0"><code>${query.query}</code></pre>
                    </div>
                `;
            });

            queriesContainer.innerHTML = html;
        }

        // Load query into editor
        function loadQueryIntoEditor(query) {
            queryEditor.setValue(query);
        }

        // Execute SQL query using Trino via Unity Catalog
        async function executeSQL() {
            const query = queryEditor.getValue().trim();
            if (!query) {
                showQueryStatus('Please enter a SQL query', 'warning');
                return;
            }

            try {
                showQueryStatus('Executing SQL via Trino engine...', 'info');
                
                // Get current catalog and schema from query or use default
                const currentCatalog = extractCatalogFromQuery(query);
                const currentSchema = extractSchemaFromQuery(query);
                
                const startTime = Date.now();
                
                const response = await fetch('/api/v1/analysis/execute-sql', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sql_query: query,
                        catalog: currentCatalog,
                        schema: currentSchema
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to execute SQL query');
                }

                const result = await response.json();
                const executionTime = Date.now() - startTime;
                
                if (result.success) {
                    currentQueryResult = result.query_result;
                    displayQueryResults(result.query_result, result.visualization_recommendation);
                    
                    showQueryStatus(`Query executed successfully via Trino: ${result.query_result.row_count} rows in ${result.execution_time_ms}ms`, 'success');
                    
                    // Show results panel
                    document.getElementById('query-results').style.display = 'block';
                } else {
                    showQueryStatus(`Query failed: ${result.error}`, 'error');
                    displayQueryError(result.error);
                }
                
            } catch (error) {
                console.error('Error executing SQL:', error);
                showQueryStatus(`SQL execution failed: ${error.message}`, 'error');
                displayQueryError(error.message);
            }
        }

        // Execute query (alias for executeSQL for backward compatibility)
        async function executeQuery() {
            await executeSQL();
        }

        // Utility functions for Unity Catalog integration
        function extractCatalogFromQuery(query) {
            // Extract catalog from query like: SELECT * FROM catalog.schema.table
            // Support various patterns: FROM catalog.schema.table, JOIN catalog.schema.table, etc.
            const patterns = [
                /FROM\s+([a-zA-Z_][a-zA-Z0-9_]*)\.[a-zA-Z_][a-zA-Z0-9_]*\.[a-zA-Z_][a-zA-Z0-9_]*/gi,
                /JOIN\s+([a-zA-Z_][a-zA-Z0-9_]*)\.[a-zA-Z_][a-zA-Z0-9_]*\.[a-zA-Z_][a-zA-Z0-9_]*/gi,
                /UPDATE\s+([a-zA-Z_][a-zA-Z0-9_]*)\.[a-zA-Z_][a-zA-Z0-9_]*\.[a-zA-Z_][a-zA-Z0-9_]*/gi,
                /INSERT\s+INTO\s+([a-zA-Z_][a-zA-Z0-9_]*)\.[a-zA-Z_][a-zA-Z0-9_]*\.[a-zA-Z_][a-zA-Z0-9_]*/gi
            ];
            
            for (const pattern of patterns) {
                const match = query.match(pattern);
                if (match) {
                    // Extract just the catalog name from the full match
                    const catalogMatch = match[0].match(/([a-zA-Z_][a-zA-Z0-9_]*)\./);
                    if (catalogMatch) {
                        console.log(`Extracted catalog: ${catalogMatch[1]}`);
                        return catalogMatch[1];
                    }
                }
            }
            
            console.log('No catalog found in query, returning null');
            return null;
        }

        function extractSchemaFromQuery(query) {
            // Extract schema from query like: SELECT * FROM catalog.schema.table
            const patterns = [
                /FROM\s+[a-zA-Z_][a-zA-Z0-9_]*\.([a-zA-Z_][a-zA-Z0-9_]*)\.[a-zA-Z_][a-zA-Z0-9_]*/gi,
                /JOIN\s+[a-zA-Z_][a-zA-Z0-9_]*\.([a-zA-Z_][a-zA-Z0-9_]*)\.[a-zA-Z_][a-zA-Z0-9_]*/gi,
                /UPDATE\s+[a-zA-Z_][a-zA-Z0-9_]*\.([a-zA-Z_][a-zA-Z0-9_]*)\.[a-zA-Z_][a-zA-Z0-9_]*/gi,
                /INSERT\s+INTO\s+[a-zA-Z_][a-zA-Z0-9_]*\.([a-zA-Z_][a-zA-Z0-9_]*)\.[a-zA-Z_][a-zA-Z0-9_]*/gi
            ];
            
            for (const pattern of patterns) {
                const match = query.match(pattern);
                if (match) {
                    // Extract the schema part
                    const schemaMatch = match[0].match(/[a-zA-Z_][a-zA-Z0-9_]*\.([a-zA-Z_][a-zA-Z0-9_]*)\./);
                    if (schemaMatch) {
                        console.log(`Extracted schema: ${schemaMatch[1]}`);
                        return schemaMatch[1];
                    }
                }
            }
            
            console.log('No schema found in query, returning null');
            return null;
        }

        function showQueryStatus(message, type = 'info') {
            const statusEl = document.getElementById('query-status');
            if (!statusEl) return;
            
            statusEl.style.display = 'block';
            
            let iconClass = 'fas fa-info-circle';
            let textClass = 'text-info';
            
            switch (type) {
                case 'success':
                    iconClass = 'fas fa-check-circle';
                    textClass = 'text-success';
                    break;
                case 'error':
                    iconClass = 'fas fa-exclamation-triangle';
                    textClass = 'text-danger';
                    break;
                case 'warning':
                    iconClass = 'fas fa-exclamation-triangle';
                    textClass = 'text-warning';
                    break;
                case 'info':
                default:
                    iconClass = 'fas fa-spinner fa-spin';
                    textClass = 'text-info';
                    break;
            }
            
            statusEl.innerHTML = `<i class="${iconClass} me-1"></i>${message}`;
            statusEl.className = `small mt-2 ${textClass}`;
            
            // Auto-hide success messages after 3 seconds
            if (type === 'success') {
                setTimeout(() => {
                    statusEl.style.display = 'none';
                }, 3000);
            }
        }

        function renderErrorMessage(message) {
            const treeContainer = document.querySelector('.catalog-tree');
            if (!treeContainer) return;
            
            treeContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Unity Catalog Error</strong><br>
                    ${message}
                    <br><br>
                    <button class="btn btn-sm btn-outline-danger" onclick="loadCatalogData()">
                        <i class="fas fa-refresh me-1"></i>Retry
                    </button>
                </div>
            `;
        }

        function updateCatalogSelector() {
            // This would update a catalog selector in the NL query panel
            // Implementation depends on the UI design
            console.log('Updating catalog selector for NL queries');
            
            // Update the natural language query input placeholder with context
            updateNLQueryPlaceholder();
        }

        function updateNLQueryPlaceholder() {
            const nlQueryInput = document.getElementById('nl-query-input');
            if (!nlQueryInput) return;
            
            if (currentTableSelection) {
                nlQueryInput.placeholder = `Ask about ${currentTableSelection.catalog}.${currentTableSelection.schema}.${currentTableSelection.table} - e.g., "Show me the top 10 rows" or "What columns does this table have?"`;
            } else {
                nlQueryInput.placeholder = "e.g., 'Show me the top 10 customers by sales' or 'How many employees are in each department?' (Select a table first for better results)";
            }
        }

        function displayQueryResults(result, visualizationRecommendation = null) {
            currentQueryResult = result;
            
            if (!result || !result.columns || !result.data) {
                document.getElementById('table-results-content').innerHTML = 
                    '<div class="alert alert-warning">No data to display</div>';
                return;
            }

            // Update query stats
            document.getElementById('query-stats').innerHTML = `
                <i class="fas fa-check-circle text-success me-1"></i>
                ${result.row_count} rows in ${result.execution_time_ms.toFixed(1)}ms
                <span class="badge bg-warning ms-2">
                    <i class="fas fa-bolt me-1"></i>Trino Engine
                </span>
                ${result.query_id ? ` | Query ID: ${result.query_id}` : ''}
            `;
            
            // Create enhanced table HTML
            let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead class="table-dark">
                            <tr>
            `;
            
            // Add column headers
            result.columns.forEach(column => {
                tableHtml += `<th>${column}</th>`;
            });
            tableHtml += '</tr></thead><tbody>';
            
            // Add data rows
            result.data.forEach(row => {
                tableHtml += '<tr>';
                row.forEach(cell => {
                    const cellValue = cell === null || cell === undefined ? 
                        '<em class="text-muted">NULL</em>' : String(cell);
                    tableHtml += `<td>${cellValue}</td>`;
                });
                tableHtml += '</tr>';
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Showing ${result.row_count} rows via Unity Catalog + Trino Engine
                        ${result.query_id ? ` | Query ID: ${result.query_id}` : ''}
                    </small>
                </div>
            `;
            
            // Update the table results content
            document.getElementById('table-results-content').innerHTML = tableHtml;
            
            // Ensure table view is active initially
            switchResultsTab('table');
            
            // Generate visualization automatically
            setTimeout(() => {
                generateVisualization(result);
            }, 100);
            
            // Show visualization recommendation if available (from external API)
            if (visualizationRecommendation) {
                setTimeout(() => {
                    showVisualizationRecommendation(visualizationRecommendation);
                }, 300);
            }
        }

        function displayQueryError(error) {
            const resultsContent = document.getElementById('table-results-content');
            resultsContent.innerHTML = `
                <div class="alert alert-danger">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Trino Query Error</h6>
                    <pre class="mt-2 mb-0">${error}</pre>
                </div>
                
                <div class="mt-3">
                    <h6>Troubleshooting Tips:</h6>
                    <ul>
                        <li>Check table and column names in your Unity Catalog</li>
                        <li>Ensure proper catalog.schema.table naming convention</li>
                        <li>Verify SQL syntax is compatible with Trino engine</li>
                        <li>Check if the data source is properly integrated with Unity Catalog</li>
                    </ul>
                </div>
            `;
            
            // Show the results panel
            document.getElementById('query-results').style.display = 'block';
        }

        // Load cross-catalog examples
        async function loadCrossCatalogExamples() {
            try {
                const response = await fetch('/api/v1/analysis/cross-catalog-examples');
                const data = await response.json();
                
                const examplesList = document.getElementById('cross-catalog-examples-list');
                examplesList.innerHTML = data.examples.map((example, index) => `
                    <div class="sample-query-item" onclick="loadQueryIntoEditor('${example.query.replace(/'/g, "\\'")}')">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <strong class="text-primary">${example.title}</strong>
                            <div>
                                <small class="text-muted me-2">${example.catalogs.join(' + ')}</small>
                                <span class="badge bg-warning">
                                    <i class="fas fa-bolt"></i> Trino
                                </span>
                            </div>
                        </div>
                        <small class="text-muted">${example.description}</small>
                    </div>
                `).join('');

            } catch (error) {
                console.error('Error loading cross-catalog examples:', error);
                document.getElementById('cross-catalog-examples-list').innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Cross-catalog examples will be available when Unity Catalog is fully configured.
                    </div>
                `;
            }
        }

        // Clear query
        function clearQuery() {
            queryEditor.setValue('');
            queryEditor.focus();
        }

        // Format query (basic SQL formatting)
        function formatQuery() {
            const query = queryEditor.getValue();
            // Basic SQL formatting
            const formatted = query
                .replace(/\bSELECT\b/gi, 'SELECT')
                .replace(/\bFROM\b/gi, '\nFROM')
                .replace(/\bWHERE\b/gi, '\nWHERE')
                .replace(/\bJOIN\b/gi, '\nJOIN')
                .replace(/\bLEFT JOIN\b/gi, '\nLEFT JOIN')
                .replace(/\bRIGHT JOIN\b/gi, '\nRIGHT JOIN')
                .replace(/\bINNER JOIN\b/gi, '\nINNER JOIN')
                .replace(/\bFULL OUTER JOIN\b/gi, '\nFULL OUTER JOIN')
                .replace(/\bORDER BY\b/gi, '\nORDER BY')
                .replace(/\bGROUP BY\b/gi, '\nGROUP BY')
                .replace(/\bHAVING\b/gi, '\nHAVING')
                .replace(/\bLIMIT\b/gi, '\nLIMIT');
            
            queryEditor.setValue(formatted);
        }

        // Handle Ctrl+Enter or Cmd+Enter to execute SQL
        function handleSQLKeyPress(event) {
            if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                event.preventDefault();
                executeSQL();
            }
        }

        // Switch between results tabs
        function switchResultsTab(tabName) {
            // Update tab appearance
            document.querySelectorAll('.results-tab').forEach(tab => tab.classList.remove('active'));
            const targetTab = document.getElementById(tabName + '-tab');
            if (targetTab) targetTab.classList.add('active');
            
            // Update header title based on selected tab
            const headerTitle = document.querySelector('.results-panel h6');
            if (headerTitle) {
                if (tabName === 'table') {
                    headerTitle.innerHTML = '<i class="fas fa-table me-2"></i>Query Results - Table View (Trino)';
                } else if (tabName === 'chart') {
                    headerTitle.innerHTML = '<i class="fas fa-chart-bar me-2"></i>Query Results - Visualization (Trino)';
                }
            }
            
            // Switch content
            if (tabName === 'table') {
                document.getElementById('table-results-content').style.display = 'block';
                document.getElementById('chart-results-content').style.display = 'none';
            } else if (tabName === 'chart') {
                document.getElementById('table-results-content').style.display = 'none';
                document.getElementById('chart-results-content').style.display = 'block';
                
                // Generate visualization if not already generated and we have data
                if (currentQueryResult && !currentVisualization) {
                    setTimeout(() => {
                        generateVisualization(currentQueryResult);
                    }, 100);
                }
            }
        }

        // Show visualization recommendation (from external API)
        function showVisualizationRecommendation(recommendation) {
            // This would handle external API visualization recommendations
            // For now, our internal AI recommendation system handles this
            console.log('External visualization recommendation:', recommendation);
            
            // Could integrate with external AI services here if needed
            const recommendationDiv = document.getElementById('chart-recommendation');
            if (recommendationDiv && recommendation) {
                const recommendationText = document.getElementById('recommendation-text');
                if (recommendationText) {
                    recommendationText.innerHTML = `
                        <strong>External AI Recommendation:</strong> ${recommendation}
                        <br><small class="text-muted">Our built-in analysis will also provide chart recommendations.</small>
                    `;
                    recommendationDiv.style.display = 'block';
                }
            }
        }

        // Refresh catalog
        function refreshCatalog() {
            loadCatalogData();
        }

        // Natural Language Query Functions
        async function executeNaturalLanguageQuery() {
            const nlQueryInput = document.getElementById('nl-query-input');
            const query = nlQueryInput.value.trim();
            
            if (!query) {
                showQueryStatus('Please enter a natural language query', 'warning');
                return;
            }
            
            try {
                showQueryStatus('Processing natural language query with AI and auto-correction...', 'info');
                
                // Get current model selection
                const modelSelect = document.getElementById('model-selector');
                const selectedModel = modelSelect.value;
                
                if (!selectedModel) {
                    throw new Error('Please select an AI model first');
                }
                
                // Send NL query to AI service with auto-correction
                const response = await fetch('/api/v1/analysis/natural-language-query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        model_key: selectedModel,  // Changed from 'model' to 'model_key'
                        catalog: currentTableSelection?.catalog || (currentCatalogData?.catalogs?.[0]?.name || 'system'),
                        schema: currentTableSelection?.schema || 'runtime',
                        conversation_history: []
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to process natural language query');
                }
                
                const result = await response.json();
                
                // API always returns a result, check if we have sql_query
                if (result.sql_query) {
                    // Set the generated SQL in the query editor
                    queryEditor.setValue(result.sql_query);
                    
                    // Enhanced status message with auto-correction info
                    let statusMessage = `AI Generated SQL: ${result.explanation}`;
                    
                    // Check if auto-correction features were mentioned in explanation
                    if (result.explanation.includes('🔧 Auto-correction: successfully fixed')) {
                        statusMessage = `✨ AI Auto-Corrected SQL with LLM: ${result.explanation}`;
                        showQueryStatus(statusMessage, 'success');
                        
                        // Show additional detailed info about the LLM correction
                        setTimeout(() => {
                            if (result.explanation.includes('EXPRESSION_NOT_AGGREGATE')) {
                                showQueryStatus('🤖 LLM Intelligence: Automatically fixed GROUP BY clause for proper SQL aggregation', 'success');
                            } else if (result.explanation.includes('TABLE_NOT_FOUND')) {
                                showQueryStatus('🤖 LLM Intelligence: Automatically corrected table references with proper catalog.schema.table format', 'success');
                            } else if (result.explanation.includes('COLUMN_NOT_FOUND')) {
                                showQueryStatus('🤖 LLM Intelligence: Automatically corrected column names based on schema analysis', 'success');
                            } else {
                                showQueryStatus('🤖 LLM Intelligence: SQL has been automatically validated and corrected!', 'success');
                            }
                        }, 2000);
                        
                        // Show fix details if available
                        if (result.explanation.includes('📝 Fix applied:')) {
                            setTimeout(() => {
                                const fixMatch = result.explanation.match(/📝 Fix applied: ([^\n]+)/);
                                if (fixMatch) {
                                    showQueryStatus(`🔧 LLM Fix Details: ${fixMatch[1]}`, 'info');
                                }
                            }, 4000);
                        }
                    } else if (result.explanation.includes('✅ SQL validation successful')) {
                        statusMessage = `✅ AI Generated & LLM Validated SQL: ${result.explanation}`;
                        showQueryStatus(statusMessage, 'success');
                        
                        setTimeout(() => {
                            showQueryStatus('✅ SQL passed LLM validation - safe to execute without correction', 'success');
                        }, 2000);
                    } else if (result.explanation.includes('⚠️ Auto-correction service unavailable')) {
                        statusMessage = `⚠️ ${result.explanation}`;
                        showQueryStatus(statusMessage, 'warning');
                        
                        setTimeout(() => {
                            showQueryStatus('⚠️ LLM auto-correction temporarily unavailable - please review SQL manually', 'warning');
                        }, 2000);
                    } else {
                        showQueryStatus(statusMessage, 'success');
                    }
                    
                    // Scroll to query editor to show the generated SQL
                    queryEditor.focus();
                    
                    // Enhanced auto-execution logic with LLM validation awareness
                    if (result.confidence > 0.9 && result.explanation.includes('✅ SQL validation successful')) {
                        showQueryStatus('🚀 High confidence LLM-validated SQL - auto-executing...', 'info');
                        setTimeout(() => {
                            executeSQL();
                        }, 1500);
                    } else if (result.confidence > 0.8 && result.explanation.includes('🔧 Auto-correction: successfully fixed')) {
                        showQueryStatus('🔧 LLM auto-correction completed with high confidence - auto-executing...', 'info');
                        setTimeout(() => {
                            executeSQL();
                        }, 2000);
                    } else if (result.confidence > 0.7 && !result.explanation.includes('⚠️')) {
                        // For medium confidence, ask user
                        setTimeout(() => {
                            showQueryStatus('📋 LLM-generated SQL ready. Click "Execute SQL" to run the query.', 'info');
                        }, 2000);
                    } else {
                        setTimeout(() => {
                            showQueryStatus('💡 SQL generated - recommend review before execution.', 'info');
                        }, 2000);
                    }
                } else {
                    throw new Error('No SQL query generated');
                }

            } catch (error) {
                console.error('Error processing natural language query:', error);
                
                let errorMessage = 'Failed to process natural language query: ' + error.message;
                
                // Provide helpful suggestions based on the error
                if (error.message.includes('model')) {
                    errorMessage += '. Please select an AI model from the configuration panel above.';
                } else if (!currentTableSelection) {
                    errorMessage += '. For better results, try selecting a table from the catalog first.';
                } else if (error.message.includes('Failed to process')) {
                    // Try to show a fallback query
                    const fallbackQuery = "SELECT 'Demo: Natural language processing with auto-correction is working!' as message, CURRENT_TIMESTAMP as generated_at";
                    queryEditor.setValue(fallbackQuery);
                    errorMessage = 'Using fallback demo query. Auto-correction features may be unavailable. ' + errorMessage;
                }
                
                showQueryStatus(errorMessage, 'error');
            }
        }

        function handleNLQueryKeyPress(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                executeNaturalLanguageQuery();
            }
        }

        // Speech Recognition Functions
        let speechRecognition = null;
        let isListening = false;

        function initializeSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.warn('Speech recognition not supported in this browser');
                const voiceButton = document.getElementById('voice-button');
                if (voiceButton) {
                    voiceButton.style.display = 'none';
                }
                return;
            }

            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            speechRecognition = new SpeechRecognition();
            
            speechRecognition.continuous = false;
            speechRecognition.interimResults = false;
            speechRecognition.lang = 'en-US';
            
            speechRecognition.onstart = function() {
                isListening = true;
                const voiceButton = document.getElementById('voice-button');
                const statusDiv = document.getElementById('nl-query-status');
                
                if (voiceButton) {
                    voiceButton.innerHTML = '<i class="fas fa-stop text-danger"></i>';
                    voiceButton.title = 'Click to stop listening';
                }
                
                if (statusDiv) {
                    statusDiv.innerHTML = '<i class="fas fa-microphone text-success me-1"></i>Listening... Speak your query now.';
                    statusDiv.style.display = 'block';
                }
            };
            
            speechRecognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                const nlQueryInput = document.getElementById('nl-query-input');
                
                if (nlQueryInput) {
                    nlQueryInput.value = transcript;
                }
                
                const statusDiv = document.getElementById('nl-query-status');
                if (statusDiv) {
                    statusDiv.innerHTML = `<i class="fas fa-check text-success me-1"></i>Captured: "${transcript}"`;
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 3000);
                }
            };
            
            speechRecognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                const statusDiv = document.getElementById('nl-query-status');
                if (statusDiv) {
                    statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle text-warning me-1"></i>Speech recognition error: ${event.error}`;
                    setTimeout(() => {
                        statusDiv.style.display = 'none';
                    }, 5000);
                }
                resetVoiceButton();
            };
            
            speechRecognition.onend = function() {
                resetVoiceButton();
            };
        }

        function toggleVoiceInput() {
            if (!speechRecognition) {
                alert('Speech recognition is not available in your browser');
                return;
            }
            
            if (isListening) {
                speechRecognition.stop();
            } else {
                try {
                    speechRecognition.start();
                } catch (error) {
                    console.error('Error starting speech recognition:', error);
                    alert('Failed to start speech recognition. Please ensure microphone permissions are granted.');
                }
            }
        }

        function resetVoiceButton() {
            isListening = false;
            const voiceButton = document.getElementById('voice-button');
            
            if (voiceButton) {
                voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
                voiceButton.title = 'Click and speak';
            }
        }

        // LLM Model Management Functions
        let availableModels = [];
        let currentModel = null;

        async function loadLLMModels() {
            try {
                showModelStatus('Loading AI models...', 'loading');
                
                const response = await fetch('/api/v1/llm/models');
                if (!response.ok) {
                    throw new Error('Failed to load models');
                }
                
                const data = await response.json();
                availableModels = data.models || [];
                
                populateModelSelector();
                showModelStatus(`Loaded ${availableModels.length} AI models`, 'success');
                
            } catch (error) {
                console.error('Error loading LLM models:', error);
                showModelStatus('Failed to load AI models: ' + error.message, 'error');
                
                // Fallback to demo models
                availableModels = [
                    { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo', provider: 'openai', status: 'available' },
                    { id: 'gpt-4', name: 'GPT-4', provider: 'openai', status: 'available' },
                    { id: 'claude-3-sonnet', name: 'Claude 3 Sonnet', provider: 'anthropic', status: 'available' }
                ];
                populateModelSelector();
                showModelStatus('Using demo models (API unavailable)', 'warning');
            }
        }

        function populateModelSelector() {
            const modelSelector = document.getElementById('model-selector');
            const providerFilter = document.getElementById('provider-filter');
            
            if (!modelSelector) return;
            
            // Clear existing options
            modelSelector.innerHTML = '<option value="">Select AI Model...</option>';
            
            // Filter models based on provider
            const selectedProvider = providerFilter?.value || 'all';
            const filteredModels = selectedProvider === 'all' ? 
                availableModels : 
                availableModels.filter(model => model.provider === selectedProvider);
            
            // Add model options
            filteredModels.forEach(model => {
                const option = document.createElement('option');
                option.value = model.id;
                option.textContent = `${model.name} (${model.provider})`;
                
                if (model.status !== 'available') {
                    option.disabled = true;
                    option.textContent += ' - Unavailable';
                }
                
                modelSelector.appendChild(option);
            });
            
            // Auto-select first available model if none selected
            if (!currentModel && filteredModels.length > 0) {
                const firstAvailable = filteredModels.find(m => m.status === 'available');
                if (firstAvailable) {
                    modelSelector.value = firstAvailable.id;
                    changeModel();
                }
            }
        }

        function changeModel() {
            const modelSelector = document.getElementById('model-selector');
            const selectedModelId = modelSelector.value;
            
            currentModel = availableModels.find(model => model.id === selectedModelId);
            
            if (currentModel) {
                updateModelInfo(currentModel);
                showModelStatus(`Selected: ${currentModel.name}`, 'success');
            } else {
                showModelStatus('No model selected', 'warning');
                document.getElementById('model-info').innerHTML = '';
            }
        }

        function filterModelsByProvider() {
            populateModelSelector();
        }

        async function refreshModels() {
            await loadLLMModels();
        }

        function updateModelInfo(model) {
            const modelInfo = document.getElementById('model-info');
            if (!modelInfo) return;
            
            modelInfo.innerHTML = `
                <div class="model-details mt-2">
                    <div class="row text-center">
                        <div class="col-4">
                            <div class="small text-muted">Provider</div>
                            <div class="fw-bold">${model.provider}</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">Status</div>
                            <div class="fw-bold text-${model.status === 'available' ? 'success' : 'warning'}">${model.status}</div>
                        </div>
                        <div class="col-4">
                            <div class="small text-muted">Type</div>
                            <div class="fw-bold">LLM</div>
                        </div>
                    </div>
                </div>
            `;
        }

        function showModelStatus(message, type) {
            const statusIndicator = document.getElementById('model-status-indicator');
            const statusText = document.getElementById('model-status-text');
            
            if (statusIndicator && statusText) {
                statusText.textContent = message;
                
                // Update indicator color
                statusIndicator.className = 'status-indicator';
                if (type === 'success') {
                    statusIndicator.classList.add('status-success');
                } else if (type === 'error') {
                    statusIndicator.classList.add('status-error');
                } else if (type === 'warning') {
                    statusIndicator.classList.add('status-warning');
                } else {
                    statusIndicator.classList.add('status-loading');
                }
            }
        }

        // === VISUALIZATION FUNCTIONS ===
        
        // Data analysis for visualization
        function analyzeDataForVisualization(data, columns) {
            if (!data || !columns || data.length === 0) {
                return null;
            }
            
            const analysis = {
                columnTypes: {},
                numericColumns: [],
                textColumns: [],
                dateColumns: [],
                sampleData: data.slice(0, Math.min(100, data.length)), // Sample for analysis
                rowCount: data.length,
                columnCount: columns.length
            };
            
            // Analyze column types based on data content
            columns.forEach((column, index) => {
                const columnData = data.map(row => row[index]).filter(val => val !== null && val !== undefined);
                
                if (columnData.length === 0) {
                    analysis.columnTypes[column] = 'empty';
                    return;
                }
                
                // Check if numeric
                const numericValues = columnData.filter(val => !isNaN(parseFloat(val)) && isFinite(val));
                if (numericValues.length > columnData.length * 0.8) {
                    analysis.columnTypes[column] = 'numeric';
                    analysis.numericColumns.push({
                        name: column,
                        index: index,
                        min: Math.min(...numericValues.map(v => parseFloat(v))),
                        max: Math.max(...numericValues.map(v => parseFloat(v))),
                        avg: numericValues.reduce((sum, v) => sum + parseFloat(v), 0) / numericValues.length
                    });
                    return;
                }
                
                // Check if date
                const dateValues = columnData.filter(val => {
                    const date = new Date(val);
                    return !isNaN(date.getTime());
                });
                if (dateValues.length > columnData.length * 0.7) {
                    analysis.columnTypes[column] = 'date';
                    analysis.dateColumns.push({
                        name: column,
                        index: index,
                        earliest: new Date(Math.min(...dateValues.map(v => new Date(v).getTime()))),
                        latest: new Date(Math.max(...dateValues.map(v => new Date(v).getTime())))
                    });
                    return;
                }
                
                // Default to text
                analysis.columnTypes[column] = 'text';
                analysis.textColumns.push({
                    name: column,
                    index: index,
                    uniqueValues: [...new Set(columnData)].length,
                    mostCommon: getMostCommonValue(columnData)
                });
            });
            
            return analysis;
        }
        
        // Get most common value in array
        function getMostCommonValue(arr) {
            const freq = {};
            let maxCount = 0;
            let mostCommon = null;
            
            arr.forEach(val => {
                freq[val] = (freq[val] || 0) + 1;
                if (freq[val] > maxCount) {
                    maxCount = freq[val];
                    mostCommon = val;
                }
            });
            
            return { value: mostCommon, count: maxCount };
        }
        
        // Recommend chart type based on data analysis
        function recommendChartType(analysis) {
            if (!analysis) return 'table';
            
            const { numericColumns, textColumns, dateColumns, rowCount } = analysis;
            
            // Single numeric column: Histogram
            if (numericColumns.length === 1 && textColumns.length === 0) {
                return 'histogram';
            }
            
            // One text column + one numeric column: Bar chart
            if (textColumns.length === 1 && numericColumns.length === 1) {
                // If text column has reasonable number of unique values, use bar chart
                if (textColumns[0].uniqueValues <= 20) {
                    return 'bar';
                }
                return 'scatter';
            }
            
            // Two numeric columns: Scatter plot
            if (numericColumns.length >= 2 && textColumns.length === 0) {
                return 'scatter';
            }
            
            // Date column + numeric column: Line chart
            if (dateColumns.length >= 1 && numericColumns.length >= 1) {
                return 'line';
            }
            
            // Text column with few unique values + numeric: Pie chart
            if (textColumns.length === 1 && numericColumns.length === 1 && 
                textColumns[0].uniqueValues <= 10 && rowCount <= 20) {
                return 'pie';
            }
            
            // Default to bar chart for simple categorical data
            if (textColumns.length >= 1 && numericColumns.length >= 1) {
                return 'bar';
            }
            
            // Fallback to table
            return 'table';
        }
        
        // Create bar chart using Plotly
        function createBarChart(data, columns, analysis) {
            const textCol = analysis.textColumns[0];
            const numericCol = analysis.numericColumns[0];
            
            if (!textCol || !numericCol) return null;
            
            // Group data by text column and sum numeric values
            const groupedData = {};
            data.forEach(row => {
                const key = row[textCol.index];
                const value = parseFloat(row[numericCol.index]) || 0;
                groupedData[key] = (groupedData[key] || 0) + value;
            });
            
            const sortedEntries = Object.entries(groupedData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 20); // Limit to top 20
            
            return {
                data: [{
                    x: sortedEntries.map(([key,]) => key),
                    y: sortedEntries.map(([, value]) => value),
                    type: 'bar',
                    marker: {
                        color: 'rgba(58, 123, 213, 0.8)',
                        line: { color: 'rgba(58, 123, 213, 1.0)', width: 1 }
                    },
                    name: numericCol.name
                }],
                layout: {
                    title: `${numericCol.name} by ${textCol.name}`,
                    xaxis: { title: textCol.name },
                    yaxis: { title: numericCol.name },
                    margin: { l: 50, r: 50, t: 50, b: 50 }
                }
            };
        }
        
        // Create line chart using Plotly
        function createLineChart(data, columns, analysis) {
            const dateCol = analysis.dateColumns[0];
            const numericCol = analysis.numericColumns[0];
            
            if (!dateCol || !numericCol) {
                // Fallback: use first two numeric columns
                if (analysis.numericColumns.length >= 2) {
                    const xCol = analysis.numericColumns[0];
                    const yCol = analysis.numericColumns[1];
                    
                    return {
                        data: [{
                            x: data.map(row => parseFloat(row[xCol.index])),
                            y: data.map(row => parseFloat(row[yCol.index])),
                            type: 'scatter',
                            mode: 'lines+markers',
                            marker: { color: 'rgba(219, 64, 82, 0.8)' },
                            name: `${yCol.name} vs ${xCol.name}`
                        }],
                        layout: {
                            title: `${yCol.name} vs ${xCol.name}`,
                            xaxis: { title: xCol.name },
                            yaxis: { title: yCol.name },
                            margin: { l: 50, r: 50, t: 50, b: 50 }
                        }
                    };
                }
                return null;
            }
            
            // Sort data by date
            const sortedData = data
                .map(row => ({
                    date: new Date(row[dateCol.index]),
                    value: parseFloat(row[numericCol.index]) || 0
                }))
                .filter(item => !isNaN(item.date.getTime()))
                .sort((a, b) => a.date - b.date);
            
            return {
                data: [{
                    x: sortedData.map(item => item.date),
                    y: sortedData.map(item => item.value),
                    type: 'scatter',
                    mode: 'lines+markers',
                    marker: { color: 'rgba(219, 64, 82, 0.8)' },
                    name: numericCol.name
                }],
                layout: {
                    title: `${numericCol.name} over Time`,
                    xaxis: { title: dateCol.name, type: 'date' },
                    yaxis: { title: numericCol.name },
                    margin: { l: 50, r: 50, t: 50, b: 50 }
                }
            };
        }
        
        // Create pie chart using Plotly
        function createPieChart(data, columns, analysis) {
            const textCol = analysis.textColumns[0];
            const numericCol = analysis.numericColumns[0];
            
            if (!textCol || !numericCol) return null;
            
            // Group data and calculate percentages
            const groupedData = {};
            let total = 0;
            
            data.forEach(row => {
                const key = row[textCol.index];
                const value = parseFloat(row[numericCol.index]) || 0;
                groupedData[key] = (groupedData[key] || 0) + value;
                total += value;
            });
            
            const sortedEntries = Object.entries(groupedData)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10); // Limit to top 10
            
            return {
                data: [{
                    labels: sortedEntries.map(([key,]) => key),
                    values: sortedEntries.map(([, value]) => value),
                    type: 'pie',
                    hole: 0.3, // Donut chart
                    textinfo: 'label+percent',
                    marker: {
                        colors: ['#3A7BD5', '#DB4052', '#00D2FF', '#FF9500', '#00C851', 
                                '#FF6B9D', '#C34632', '#00BFA5', '#FF5722', '#795548']
                    }
                }],
                layout: {
                    title: `Distribution of ${numericCol.name} by ${textCol.name}`,
                    margin: { l: 50, r: 50, t: 50, b: 50 }
                }
            };
        }
        
        // Create scatter plot using Plotly
        function createScatterPlot(data, columns, analysis) {
            if (analysis.numericColumns.length < 2) return null;
            
            const xCol = analysis.numericColumns[0];
            const yCol = analysis.numericColumns[1];
            const colorCol = analysis.textColumns[0]; // Optional color grouping
            
            let plotData;
            
            if (colorCol && colorCol.uniqueValues <= 10) {
                // Group by color column
                const groups = {};
                data.forEach(row => {
                    const groupKey = row[colorCol.index];
                    if (!groups[groupKey]) groups[groupKey] = { x: [], y: [] };
                    groups[groupKey].x.push(parseFloat(row[xCol.index]));
                    groups[groupKey].y.push(parseFloat(row[yCol.index]));
                });
                
                plotData = Object.entries(groups).map(([groupName, groupData], index) => ({
                    x: groupData.x,
                    y: groupData.y,
                    mode: 'markers',
                    type: 'scatter',
                    name: groupName,
                    marker: {
                        color: ['#3A7BD5', '#DB4052', '#00D2FF', '#FF9500', '#00C851'][index % 5],
                        size: 8
                    }
                }));
            } else {
                // Single scatter plot
                plotData = [{
                    x: data.map(row => parseFloat(row[xCol.index])),
                    y: data.map(row => parseFloat(row[yCol.index])),
                    mode: 'markers',
                    type: 'scatter',
                    marker: {
                        color: 'rgba(58, 123, 213, 0.8)',
                        size: 8
                    },
                    name: 'Data Points'
                }];
            }
            
            return {
                data: plotData,
                layout: {
                    title: `${yCol.name} vs ${xCol.name}`,
                    xaxis: { title: xCol.name },
                    yaxis: { title: yCol.name },
                    margin: { l: 50, r: 50, t: 50, b: 50 }
                }
            };
        }
        
        // Create histogram using Plotly
        function createHistogram(data, columns, analysis) {
            if (analysis.numericColumns.length === 0) return null;
            
            const numericCol = analysis.numericColumns[0];
            const values = data.map(row => parseFloat(row[numericCol.index])).filter(val => !isNaN(val));
            
            return {
                data: [{
                    x: values,
                    type: 'histogram',
                    marker: {
                        color: 'rgba(58, 123, 213, 0.8)',
                        line: { color: 'rgba(58, 123, 213, 1.0)', width: 1 }
                    },
                    name: 'Frequency'
                }],
                layout: {
                    title: `Distribution of ${numericCol.name}`,
                    xaxis: { title: numericCol.name },
                    yaxis: { title: 'Frequency' },
                    margin: { l: 50, r: 50, t: 50, b: 50 }
                }
            };
        }
        
        // Create box plot using Plotly
        function createBoxPlot(data, columns, analysis) {
            if (analysis.numericColumns.length === 0) return null;
            
            const numericCol = analysis.numericColumns[0];
            const values = data.map(row => parseFloat(row[numericCol.index])).filter(val => !isNaN(val));
            
            return {
                data: [{
                    y: values,
                    type: 'box',
                    name: numericCol.name,
                    marker: { color: 'rgba(58, 123, 213, 0.8)' }
                }],
                layout: {
                    title: `Box Plot of ${numericCol.name}`,
                    yaxis: { title: numericCol.name },
                    margin: { l: 50, r: 50, t: 50, b: 50 }
                }
            };
        }
        
        // Main visualization generation function
        function generateVisualization(result, chartType = null) {
            if (!result || !result.columns || !result.data || result.data.length === 0) {
                document.getElementById('chart-container').innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-chart-bar fa-3x mb-3"></i>
                        <p>No data available for visualization</p>
                    </div>
                `;
                return;
            }
            
            // Analyze data
            const analysis = analyzeDataForVisualization(result.data, result.columns);
            if (!analysis) {
                document.getElementById('chart-container').innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <p>Unable to analyze data for visualization</p>
                    </div>
                `;
                return;
            }
            
            // Determine chart type
            const recommendedType = recommendChartType(analysis);
            const finalChartType = chartType || recommendedType;
            
            // Show recommendation
            showChartRecommendation(recommendedType, analysis);
            
            // Update chart type selector
            const chartTypeSelector = document.getElementById('chart-type-selector');
            if (chartTypeSelector) {
                chartTypeSelector.value = finalChartType;
            }
            
            // Generate chart based on type
            let plotConfig = null;
            
            switch (finalChartType) {
                case 'bar':
                    plotConfig = createBarChart(result.data, result.columns, analysis);
                    break;
                case 'line':
                    plotConfig = createLineChart(result.data, result.columns, analysis);
                    break;
                case 'pie':
                    plotConfig = createPieChart(result.data, result.columns, analysis);
                    break;
                case 'scatter':
                    plotConfig = createScatterPlot(result.data, result.columns, analysis);
                    break;
                case 'histogram':
                    plotConfig = createHistogram(result.data, result.columns, analysis);
                    break;
                case 'box':
                    plotConfig = createBoxPlot(result.data, result.columns, analysis);
                    break;
                default:
                    // Show table view
                    document.getElementById('chart-container').innerHTML = `
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-table fa-3x mb-3"></i>
                            <p>Table view selected. Switch to "Table View" tab to see data.</p>
                        </div>
                    `;
                    return;
            }
            
            if (plotConfig) {
                // Show chart controls
                document.getElementById('chart-controls').style.display = 'flex';
                
                // Render chart using Plotly
                Plotly.newPlot('chart-container', plotConfig.data, plotConfig.layout, {
                    responsive: true,
                    displayModeBar: true,
                    modeBarButtonsToAdd: ['pan2d', 'select2d', 'lasso2d'],
                    displaylogo: false
                });
                
                // Store current visualization data for updates
                currentVisualization = {
                    result: result,
                    analysis: analysis,
                    chartType: finalChartType
                };
            } else {
                document.getElementById('chart-container').innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-exclamation-circle fa-3x mb-3"></i>
                        <p>Unable to create ${finalChartType} chart with this data</p>
                        <p class="small">Try selecting a different chart type or switch to table view</p>
                    </div>
                `;
            }
        }
        
        // Show chart recommendation
        function showChartRecommendation(recommendedType, analysis) {
            const recommendationDiv = document.getElementById('chart-recommendation');
            const recommendationText = document.getElementById('recommendation-text');
            
            if (!recommendationDiv || !recommendationText) return;
            
            let message = `AI recommends <strong>${recommendedType}</strong> chart for this data.`;
            
            if (analysis) {
                const details = [];
                if (analysis.numericColumns.length > 0) {
                    details.push(`${analysis.numericColumns.length} numeric column(s)`);
                }
                if (analysis.textColumns.length > 0) {
                    details.push(`${analysis.textColumns.length} categorical column(s)`);
                }
                if (analysis.dateColumns.length > 0) {
                    details.push(`${analysis.dateColumns.length} date column(s)`);
                }
                
                if (details.length > 0) {
                    message += ` <small class="text-muted">(${details.join(', ')})</small>`;
                }
            }
            
            recommendationText.innerHTML = message;
            recommendationDiv.style.display = 'block';
        }
        
        // Update visualization when chart type changes
        function updateVisualization() {
            if (!currentVisualization) return;
            
            const chartTypeSelector = document.getElementById('chart-type-selector');
            const selectedType = chartTypeSelector.value;
            
            generateVisualization(currentVisualization.result, selectedType);
        }
        
        // Refresh visualization
        function refreshVisualization() {
            if (!currentVisualization) return;
            
            generateVisualization(currentVisualization.result, currentVisualization.chartType);
        }
    </script>
</body>
</html> 